<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAC Style Makeup Store</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script src="js/firebase-config.js"></script>

    <style>
        /* Variables y Reset */
        :root {
            --primary-color: #e91e63;
            --secondary-color: #9c27b0;
            --accent-color: #ff4081;
            --text-color: #333;
            --light-bg: #f8f9fa;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --base-font-size: 16px;
            --base-spacing: 1rem;
            --site-header-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            padding-top: var(--site-header-height);
            font-size: var(--base-font-size);
        }

        /* Header */
        .navbar {
            background: var(--white);
            box-shadow: var(--shadow);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            height: var(--site-header-height);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }

        .logo h2 {
            color: var(--primary-color);
        }

        .logo a {
            text-decoration: none;
            color: inherit;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 30px;
            align-items: center;
        }

        .nav-menu a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-menu a:hover {
            color: var(--primary-color);
        }

        .cart-icon {
            position: relative;
        }

        .cart-count {
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            position: absolute;
            top: -8px;
            right: -8px;
        }

        /* ESTILOS PARA EL BUSCADOR MEJORADO */
        .search-container {
            flex: 1;
            max-width: 500px;
            margin: 0 20px;
        }

        .search-form {
            display: flex;
            width: 100%;
        }

        .search-form input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-right: none;
            border-radius: 25px 0 0 25px;
            font-size: 14px;
            outline: none;
        }

        .search-form input:focus {
            border-color: var(--primary-color);
        }

        .search-form button {
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }

        .voice-btn {
            background: var(--secondary-color);
            color: white;
            padding: 0 15px;
            border-left: 1px solid #e0e0e0;
        }

        .voice-btn:hover {
            background: #7b1fa2;
        }

        .search-btn {
            background: var(--primary-color);
            color: white;
            padding: 0 20px;
            border-radius: 0 25px 25px 0;
        }

        .search-btn:hover {
            background: #c2185b;
        }

        .voice-listening {
            background: var(--primary-color) !important;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Dropdown */
        .dropdown {
            position: relative;
        }

        .dropdown-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            font-size: 1.2rem;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            box-shadow: var(--shadow);
            border-radius: 8px;
            padding: 10px;
            min-width: 250px;
            z-index: 1000;
        }

        .dropdown-content a,
        .dropdown-content button {
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            padding: 8px 12px;
            text-decoration: none;
            color: var(--text-color);
            cursor: pointer;
            border-radius: 4px;
        }

        .dropdown-content a:hover,
        .dropdown-content button:hover {
            background: #f5f5f5;
        }

        /* Controles de accesibilidad */
        .accessibility-controls {
            padding: 10px 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            margin: 10px 0;
        }

        .accessibility-controls details {
            margin-bottom: 10px;
        }

        .accessibility-controls summary {
            cursor: pointer;
            font-weight: bold;
            padding: 5px 0;
        }

        .accessibility-controls .control-group {
            margin-top: 10px;
            padding-left: 10px;
        }

        .accessibility-controls label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .accessibility-controls input[type="range"] {
            width: 100%;
            margin-bottom: 10px;
        }

        .accessibility-controls button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 0.9rem;
        }

        /* Estilos para modo oscuro */
        .dark-mode {
            background-color: #1a1a1a;
            color: #f0f0f0;
        }

        .dark-mode .navbar {
            background: #2d2d2d;
        }

        .dark-mode .nav-menu a {
            color: #f0f0f0;
        }

        .dark-mode .dropdown-content {
            background: #2d2d2d;
            color: #f0f0f0;
        }

        .dark-mode .dropdown-content a,
        .dark-mode .dropdown-content button {
            color: #f0f0f0;
        }

        .dark-mode .dropdown-content a:hover,
        .dark-mode .dropdown-content button:hover {
            background: #3d3d3d;
        }

        /* Estilos para alto contraste */
        .high-contrast {
            background: #000 !important;
            color: #fff !important;
        }

        .high-contrast .navbar {
            background: #000 !important;
            border-bottom: 2px solid #fff;
        }

        .high-contrast .nav-menu a {
            color: #ffff00 !important;
        }

        .high-contrast .dropdown-content {
            background: #000 !important;
            border: 2px solid #fff;
        }

        .high-contrast a {
            color: #ffff00 !important;
        }

        /* Estilos para escala de grises */
        .grayscale {
            filter: grayscale(var(--grayscale-percent, 100%));
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 150px 0 100px;
            text-align: center;
            margin-top: 70px;
        }

        .hero-content h1 {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .hero-content p {
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .cta-button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 25px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .cta-button:hover {
            transform: translateY(-2px);
        }

        /* Products Section */
        .products {
            padding: 80px 0;
            background: var(--light-bg);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .products h2 {
            text-align: center;
            margin-bottom: 50px;
            font-size: 2.5rem;
            color: var(--primary-color);
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
        }

        .product-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
        }

        .product-image {
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-card h3 {
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .product-price {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .add-to-cart {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .add-to-cart:hover {
            background: var(--accent-color);
        }

        /* Estilos para resultados de b√∫squeda */
        .search-results-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid var(--primary-color);
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
            grid-column: 1 / -1;
        }

        .no-results i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ccc;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: #f0f0f0;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .filter-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Page Sections */
        .page-section {
            padding: 40px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Estilos para accesibilidad */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .sr-announcement {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--primary-color);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            z-index: 9999;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .sr-announcement.show {
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-container {
                flex-wrap: wrap;
                height: auto;
                padding: 10px 20px;
            }

            .search-container {
                order: 3;
                flex: 1 1 100%;
                margin: 10px 0 0 0;
                max-width: none;
            }

            .nav-menu {
                gap: 15px;
            }

            .hero-content h1 {
                font-size: 2rem;
            }

            .product-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
                align-items: center;
            }

            .filter-btn {
                width: 200px;
            }

            .dropdown-content {
                min-width: 200px;
                right: -10px;
            }
        }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-container">
        <!-- Logo -->
        <div class="logo">
            <h2><a href="#home">MAC Style</a></h2>
        </div>

        <!-- Buscador Mejorado -->
        <div class="search-container">
            <form class="search-form" onsubmit="buscarProductos(event)">
                <input type="text" id="search-input" placeholder="Buscar productos..." value="">
                <button type="button" class="voice-btn" id="voice-search-btn" title="B√∫squeda por voz">
                    <i class="fas fa-microphone"></i>
                </button>
                <button type="submit" class="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </form>
        </div>

        <!-- Men√∫ de navegaci√≥n -->
        <ul class="nav-menu">
            <li id="admin-link" style="display: none;">
                <a href="#admin">Administraci√≥n</a>
            </li>
            
            <li><a href="#products">Productos</a></li>
            <li><a href="#products?category=labios">Labios</a></li>
            <li><a href="#products?category=ojos">Ojos</a></li>
            <li><a href="#products?category=rostro">Rostro</a></li>
            
            <li id="cart-link" style="display: none;">
                <a href="#cart" class="cart-icon">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count">0</span>
                </a>
            </li>
            
            <li id="user-info" style="display: none;">
                <span class="user-welcome" id="user-welcome"></span>
            </li>

            <!-- Men√∫ desplegable -->
            <li class="dropdown">
                <button class="dropdown-btn">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="dropdown-content">
                    <a href="#guide">Gu√≠a de usuario</a>
                    
                    <div class="accessibility-controls">
                        <details>
                            <summary>Tama√±o de lectura</summary>
                            <div class="control-group">
                                <label for="fontSizeRange">
                                    <span>Fuente</span>
                                    <span id="fontSizeValue">16px</span>
                                </label>
                                <input id="fontSizeRange" type="range" min="12" max="28" step="1" value="16">
                                <button id="fontSizeReset">Restablecer</button>
                            </div>
                        </details>

                        <details>
                            <summary>Espaciado</summary>
                            <div class="control-group">
                                <label for="spacingRange">
                                    <span>Interlineado</span>
                                    <span id="spacingValue">1rem</span>
                                </label>
                                <input id="spacingRange" type="range" min="0.5" max="2.0" step="0.05" value="1.0">
                                <button id="spacingReset">Restablecer</button>
                            </div>
                        </details>

                        <button id="toggleContrastBtn">Alto contraste</button>

                        <details>
                            <summary>Escala de grises</summary>
                            <div class="control-group">
                                <label for="grayscaleRange">
                                    <span>Intensidad</span>
                                    <span id="grayscaleValue">0%</span>
                                </label>
                                <input id="grayscaleRange" type="range" min="0" max="100" step="1" value="0">
                                <button id="grayscaleReset">Restablecer</button>
                            </div>
                        </details>
                    </div>

                    <button id="srToggleBtnMenu">Lector</button>
                    <button id="themeToggleBtnMenu">Cambiar a modo oscuro</button>
                    
                    <div id="auth-links">
                        <a href="#login">Iniciar Sesi√≥n</a>
                        <a href="#register">Registrarse</a>
                    </div>
                </div>
            </li>
        </ul>
    </div>
</nav>

<main id="main-content">
    <div id="page-content">
        <!-- Contenido se cargar√° din√°micamente aqu√≠ -->
    </div>
</main>

<div id="sr-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>
<div id="sr-visual-announcer" class="sr-announcement" aria-hidden="true"></div>

<script>
// ====================================================================
// SISTEMA DE RUTAS
// ====================================================================
function cargarPagina(pagina, parametros = {}) {
    const contenido = document.getElementById('page-content');
    
    switch(pagina) {
        case 'home':
            contenido.innerHTML = `
                <section class="hero">
                    <div class="hero-content">
                        <h1>Bienvenido a MAC Style</h1>
                        <p>Descubre la mejor colecci√≥n de maquillaje profesional</p>
                        <a href="#products" class="cta-button">Ver Productos</a>
                    </div>
                </section>
                <section class="offers">
                    <div class="container">
                        <div class="offer-banner">
                            <h2>Ofertas Especiales</h2>
                            <p>Hasta 50% de descuento en productos seleccionados</p>
                        </div>
                    </div>
                </section>
            `;
            break;
            
        case 'products':
            const categoria = parametros.category || 'all';
            const terminoBusqueda = parametros.search || '';
            contenido.innerHTML = `
                <section class="products">
                    <div class="container">
                        <h2>Nuestros Productos</h2>
                        <div class="filters">
                            <button onclick="filtrarProductos('all')" class="filter-btn ${categoria === 'all' ? 'active' : ''}">
                                Todos
                            </button>
                            <button onclick="filtrarProductos('labios')" class="filter-btn ${categoria === 'labios' ? 'active' : ''}">
                                Labios
                            </button>
                            <button onclick="filtrarProductos('ojos')" class="filter-btn ${categoria === 'ojos' ? 'active' : ''}">
                                Ojos
                            </button>
                            <button onclick="filtrarProductos('rostro')" class="filter-btn ${categoria === 'rostro' ? 'active' : ''}">
                                Rostro
                            </button>
                        </div>
                        ${terminoBusqueda ? `
                            <div class="search-results-info">
                                <h3>Resultados de b√∫squeda para: <strong>"${terminoBusqueda}"</strong></h3>
                            </div>
                        ` : ''}
                        <div id="products-grid" class="product-grid"></div>
                    </div>
                </section>
            `;
            cargarProductos(categoria, terminoBusqueda);
            break;
            
        case 'cart':
            contenido.innerHTML = `
                <section class="products">
                    <div class="container">
                        <h2>Tu Carrito de Compras</h2>
                        <div id="cart-items"></div>
                        <div class="cart-total">
                            Total: $<span id="total-price">0.00</span> MXN
                        </div>
                        <button class="checkout-btn" onclick="redirigirACheckout()">Proceder al Pago</button>
                    </div>
                </section>
            `;
            mostrarCarrito();
            break;
            
        case 'checkout':
            contenido.innerHTML = `
                <section class="page-section">
                    <h1>Proceso de Pago</h1>
                    <iframe src="checkout.html" class="page-iframe" title="Proceso de pago Mercado Pago" 
                            style="width: 100%; height: 600px; border: none; border-radius: 8px;"></iframe>
                </section>
            `;
            break;
            
        case 'guide':
        case 'login':
        case 'register':
            const titleMap = {
                'guide': 'Gu√≠a de Usuario',
                'login': 'Iniciar Sesi√≥n',
                'register': 'Registrarse'
            };
            const pageTitle = titleMap[pagina] || pagina;

            contenido.innerHTML = `
                <section class="page-section">
                    <h1>${pageTitle}</h1>
                    <iframe src="${pagina}.html" class="page-iframe" title="${pageTitle}"
                            style="width: 100%; height: 600px; border: none; border-radius: 8px;"></iframe>
                </section>
            `;
            break;
            
        default:
            cargarPagina('home');
    }
}

// ====================================================================
// FUNCIONES DE PRODUCTOS
// ====================================================================
async function cargarProductos(categoria = 'all', terminoBusqueda = '') {
    try {
        console.log('üîÑ Cargando productos...', categoria, terminoBusqueda);
        
        if (typeof db === 'undefined') {
            console.error('‚ùå Firestore no est√° inicializado');
            mostrarProductos([]);
            return;
        }
        
        let query = db.collection('products');
        
        if (categoria !== 'all') {
            query = query.where('category', '==', categoria);
        }
        
        const snapshot = await query.get();
        let productos = [];
        
        snapshot.forEach(doc => {
            const data = doc.data();
            productos.push({ 
                id: doc.id, 
                name: data.name,
                description: data.description,
                price: data.price,
                category: data.category,
                imageUrl: data.image || data.imageUrl
            });
        });
        
        // Filtrar por t√©rmino de b√∫squeda
        if (terminoBusqueda) {
            const termino = terminoBusqueda.toLowerCase();
            productos = productos.filter(producto => 
                producto.name.toLowerCase().includes(termino) ||
                producto.description.toLowerCase().includes(termino) ||
                producto.category.toLowerCase().includes(termino)
            );
        }
        
        console.log(`‚úÖ ${productos.length} productos cargados`);
        mostrarProductos(productos);
        
    } catch (error) {
        console.error('‚ùå Error cargando productos:', error);
        mostrarProductos([]);
    }
}

function mostrarProductos(productos) {
    const grid = document.getElementById('products-grid');
    
    if (!grid) return;
    
    if (productos.length === 0) {
        grid.innerHTML = `
            <div class="no-results">
                <i class="fas fa-search"></i>
                <h3>No se encontraron productos</h3>
                <p>Intenta con otros t√©rminos de b√∫squeda o categor√≠as</p>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = productos.map(producto => `
        <div class="product-card">
            <div class="product-image">
                <img src="${producto.imageUrl}" 
                     alt="${producto.name}"
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+SW1hZ2VuIG5vIGRpc3BvbmlibGU8L3RleHQ+PC9zdmc+'">
            </div>
            <h3>${producto.name}</h3>
            <p>${producto.description}</p>
            <div class="product-price">$${producto.price} MXN</div>
            <button class="add-to-cart" onclick="agregarAlCarrito('${producto.id}', '${producto.name.replace(/'/g, "\\'")}', ${producto.price}, '${producto.category}')">
                <i class="fas fa-cart-plus"></i> Agregar al Carrito
            </button>
        </div>
    `).join('');
}

function filtrarProductos(categoria) {
    console.log('üîç Filtrando por categor√≠a:', categoria);
    window.location.hash = `products${categoria !== 'all' ? `?category=${categoria}` : ''}`;
}

// ====================================================================
// B√öSQUEDA POR VOZ - VERSI√ìN CORREGIDA
// ====================================================================
let recognition = null;
let isListening = false;

function inicializarReconocimientoVoz() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        console.warn('El reconocimiento de voz no es compatible con este navegador');
        document.getElementById('voice-search-btn').style.display = 'none';
        return;
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'es-ES';
    
    recognition.onstart = function() {
        isListening = true;
        document.getElementById('voice-search-btn').classList.add('voice-listening');
        srAnnounce('Escuchando... Habla ahora');
    };
    
    recognition.onresult = function(event) {
        let transcript = event.results[0][0].transcript;
        
        // LIMPIEZA DEL TEXTO - CORRECCI√ìN DEL PUNTO
        transcript = transcript
            .trim() // Eliminar espacios al inicio y final
            .replace(/\.$/, '') // Eliminar punto final
            .replace(/\s+\.$/, '') // Eliminar punto despu√©s de espacios
            .replace(/\s+/g, ' ') // Normalizar espacios m√∫ltiples
        
        console.log('Texto reconocido (limpio):', transcript);
        
        document.getElementById('search-input').value = transcript;
        srAnnounce(`B√∫squeda por voz: "${transcript}"`);
        
        // Peque√±o delay para que el usuario vea el texto
        setTimeout(() => {
            buscarProductos(new Event('submit'));
        }, 500);
    };
    
    recognition.onerror = function(event) {
        console.error('Error en reconocimiento de voz:', event.error);
        srAnnounce('Error en el reconocimiento de voz');
    };
    
    recognition.onend = function() {
        isListening = false;
        document.getElementById('voice-search-btn').classList.remove('voice-listening');
    };
}

function toggleReconocimientoVoz() {
    if (!recognition) {
        inicializarReconocimientoVoz();
    }
    
    if (isListening) {
        recognition.stop();
    } else {
        recognition.start();
    }
}

// ====================================================================
// BUSCADOR MEJORADO CON LIMPIEZA
// ====================================================================
function buscarProductos(event) {
    if (event) event.preventDefault();
    
    let termino = document.getElementById('search-input').value.trim();
    
    // Limpieza adicional por si el usuario escribe con punto
    termino = termino.replace(/\.$/, '').trim();
    
    if (termino) {
        console.log('üîç Buscando:', termino);
        srAnnounce(`Buscando: "${termino}"`);
        window.location.hash = `products?search=${encodeURIComponent(termino)}`;
    } else {
        window.location.hash = 'products';
    }
}

// ====================================================================
// FUNCIONES DEL CARRITO
// ====================================================================
function agregarAlCarrito(id, nombre, precio, categoria = 'General') {
    let carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    const existe = carrito.find(item => item.id === id);
    
    if (existe) {
        existe.cantidad++;
    } else {
        carrito.push({ 
            id, 
            nombre, 
            precio: parseFloat(precio), 
            cantidad: 1,
            categoria: categoria
        });
    }
    
    localStorage.setItem('carrito', JSON.stringify(carrito));
    actualizarContadorCarrito();
    
    const cartCount = document.querySelector('.cart-count');
    if (cartCount) {
        cartCount.classList.add('bump');
        setTimeout(() => cartCount.classList.remove('bump'), 200);
    }
    
    srAnnounce(`${nombre} agregado al carrito`);
}

function actualizarContadorCarrito() {
    const carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    const total = carrito.reduce((sum, item) => sum + item.cantidad, 0);
    const cartCountEl = document.querySelector('.cart-count');
    if (cartCountEl) {
        cartCountEl.textContent = total;
    }
}

function mostrarCarrito() {
    const carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    const itemsDiv = document.getElementById('cart-items');
    const totalDiv = document.getElementById('total-price');
    
    if (!itemsDiv || !totalDiv) return;

    if (carrito.length === 0) {
        itemsDiv.innerHTML = '<p>Tu carrito est√° vac√≠o</p>';
        totalDiv.textContent = '0.00';
        return;
    }
    
    let total = 0;
    itemsDiv.innerHTML = carrito.map(item => {
        const subtotal = item.precio * item.cantidad;
        total += subtotal;
        return `
            <div class="cart-item">
                <div class="cart-item-info">
                    <h3>${item.nombre}</h3>
                    <p>Precio: $${item.precio.toFixed(2)} x ${item.cantidad} = $${subtotal.toFixed(2)}</p>
                </div>
                <div class="cart-item-actions">
                    <button onclick="cambiarCantidad('${item.id}', ${item.cantidad - 1})">-</button>
                    <span>${item.cantidad}</span>
                    <button onclick="cambiarCantidad('${item.id}', ${item.cantidad + 1})">+</button>
                    <button onclick="removerDelCarrito('${item.id}')">Eliminar</button>
                </div>
            </div>
        `;
    }).join('');
    
    totalDiv.textContent = total.toFixed(2);
}

function cambiarCantidad(id, nuevaCantidad) {
    if (nuevaCantidad < 1) {
        removerDelCarrito(id);
        return;
    }
    
    let carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    const item = carrito.find(item => item.id === id);
    
    if (item) {
        item.cantidad = nuevaCantidad;
        localStorage.setItem('carrito', JSON.stringify(carrito));
        mostrarCarrito();
        actualizarContadorCarrito();
    }
}

function removerDelCarrito(id) {
    let carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    const itemNombre = carrito.find(item => item.id === id)?.nombre || 'Producto';
    carrito = carrito.filter(item => item.id !== id);
    localStorage.setItem('carrito', JSON.stringify(carrito));
    mostrarCarrito();
    actualizarContadorCarrito();
    srAnnounce(`${itemNombre} eliminado del carrito`);
}

function redirigirACheckout() {
    const carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    
    if (carrito.length === 0) {
        srAnnounce('Tu carrito est√° vac√≠o, no puedes pagar');
        alert('Tu carrito est√° vac√≠o');
        return;
    }
    
    window.location.hash = 'checkout';
    srAnnounce('Redirigiendo al proceso de pago');
}

// ====================================================================
// FUNCIONES DE ACCESIBILIDAD
// ====================================================================
function srAnnounce(msg, politeness = 'polite', visualFeedback = true) {
    const el = document.getElementById('sr-announcer');
    if (el) {
        el.setAttribute('aria-live', politeness);
        el.textContent = '';
        setTimeout(() => el.textContent = msg, 100);
    }
    
    if (visualFeedback) {
        const visualEl = document.getElementById('sr-visual-announcer');
        if (visualEl) {
            visualEl.textContent = msg;
            visualEl.classList.add('show');
            setTimeout(() => {
                visualEl.classList.remove('show');
            }, 3000);
        }
    }
}

// ====================================================================
// CONTROLES DE ACCESIBILIDAD
// ====================================================================
function inicializarControlesAccesibilidad() {
    // Tama√±o de fuente
    const fontSizeRange = document.getElementById('fontSizeRange');
    const fontSizeValue = document.getElementById('fontSizeValue');
    const fontSizeReset = document.getElementById('fontSizeReset');
    
    if (fontSizeRange) {
        fontSizeRange.addEventListener('input', function() {
            document.documentElement.style.fontSize = this.value + 'px';
            fontSizeValue.textContent = this.value + 'px';
        });
        
        fontSizeReset.addEventListener('click', function() {
            fontSizeRange.value = 16;
            document.documentElement.style.fontSize = '16px';
            fontSizeValue.textContent = '16px';
            srAnnounce('Tama√±o de fuente restablecido');
        });
    }
    
    // Espaciado
    const spacingRange = document.getElementById('spacingRange');
    const spacingValue = document.getElementById('spacingValue');
    const spacingReset = document.getElementById('spacingReset');
    
    if (spacingRange) {
        spacingRange.addEventListener('input', function() {
            document.documentElement.style.setProperty('--base-spacing', this.value + 'rem');
            spacingValue.textContent = this.value + 'rem';
        });
        
        spacingReset.addEventListener('click', function() {
            spacingRange.value = 1.0;
            document.documentElement.style.setProperty('--base-spacing', '1rem');
            spacingValue.textContent = '1rem';
            srAnnounce('Espaciado restablecido');
        });
    }
    
    // Alto contraste
    const toggleContrastBtn = document.getElementById('toggleContrastBtn');
    
    if (toggleContrastBtn) {
        toggleContrastBtn.addEventListener('click', function() {
            document.body.classList.toggle('high-contrast');
            const isActive = document.body.classList.contains('high-contrast');
            this.textContent = isActive ? 'Desactivar alto contraste' : 'Alto contraste';
            srAnnounce(isActive ? 'Alto contraste activado' : 'Alto contraste desactivado');
        });
    }
    
    // Escala de grises
    const grayscaleRange = document.getElementById('grayscaleRange');
    const grayscaleValue = document.getElementById('grayscaleValue');
    const grayscaleReset = document.getElementById('grayscaleReset');
    
    if (grayscaleRange) {
        grayscaleRange.addEventListener('input', function() {
            document.documentElement.style.setProperty('--grayscale-percent', this.value + '%');
            grayscaleValue.textContent = this.value + '%';
            document.body.classList.toggle('grayscale', this.value > 0);
        });
        
        grayscaleReset.addEventListener('click', function() {
            grayscaleRange.value = 0;
            document.documentElement.style.setProperty('--grayscale-percent', '0%');
            grayscaleValue.textContent = '0%';
            document.body.classList.remove('grayscale');
            srAnnounce('Escala de grises restablecida');
        });
    }
    
    // Lector de pantalla
    const srToggleBtnMenu = document.getElementById('srToggleBtnMenu');
    let srEnabled = false;
    
    if (srToggleBtnMenu) {
        srToggleBtnMenu.addEventListener('click', function() {
            srEnabled = !srEnabled;
            this.textContent = srEnabled ? 'Desactivar lector' : 'Lector';
            this.classList.toggle('active', srEnabled);
            
            if (srEnabled) {
                srAnnounce('Lector de pantalla activado', 'assertive');
            } else {
                srAnnounce('Lector de pantalla desactivado', 'assertive');
            }
        });
    }
    
    // Modo oscuro
    const themeToggleBtnMenu = document.getElementById('themeToggleBtnMenu');
    
    if (themeToggleBtnMenu) {
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            themeToggleBtnMenu.textContent = 'Cambiar a modo claro';
        }
        
        themeToggleBtnMenu.addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            this.textContent = isDark ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro';
            localStorage.setItem('darkMode', isDark);
            srAnnounce(isDark ? 'Modo oscuro activado' : 'Modo claro activado');
        });
    }
}

// ====================================================================
// INICIALIZACI√ìN
// ====================================================================
document.addEventListener('DOMContentLoaded', function() {
    // Sistema de rutas
    window.addEventListener('hashchange', function() {
        const hash = window.location.hash.substring(1);
        let pagina = 'home';
        let parametros = {};
        
        if (hash.includes('?')) {
            const parts = hash.split('?');
            pagina = parts[0];
            const searchParams = new URLSearchParams(parts[1]);
            parametros = Object.fromEntries(searchParams.entries());
        } else if (hash) {
            pagina = hash;
        }
        
        cargarPagina(pagina, parametros);
    });
    
    // Cargar p√°gina inicial
    const hash = window.location.hash.substring(1);
    if (!hash) {
        cargarPagina('home');
    } else {
        window.dispatchEvent(new Event('hashchange'));
    }
    
    // Inicializar componentes
    actualizarContadorCarrito();
    inicializarReconocimientoVoz();
    inicializarControlesAccesibilidad();
    
    // Event listeners
    document.getElementById('voice-search-btn').addEventListener('click', toggleReconocimientoVoz);
    
    // Dropdown menu
    const dropdownBtn = document.querySelector('.dropdown-btn');
    const dropdownContent = document.querySelector('.dropdown-content');
    
    if (dropdownBtn && dropdownContent) {
        dropdownBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
        });
        
        document.addEventListener('click', function() {
            dropdownContent.style.display = 'none';
        });
    }
    
    // Auth state
    if (typeof auth !== 'undefined') {
        auth.onAuthStateChanged(usuario => {
            const userInfo = document.getElementById('user-info');
            const authLinks = document.getElementById('auth-links');
            const cartLink = document.getElementById('cart-link');
            const adminLink = document.getElementById('admin-link');
            
            if (usuario) {
                userInfo.style.display = 'block';
                cartLink.style.display = 'block';
                document.getElementById('user-welcome').textContent = `Hola, ${usuario.email}`;
                authLinks.innerHTML = '<a href="#" onclick="logout()">Cerrar Sesi√≥n</a>';
                
                if (typeof db !== 'undefined') {
                    db.collection('users').doc(usuario.uid).get().then(doc => {
                        if (doc.exists && doc.data().role === 'admin') {
                            adminLink.style.display = 'block';
                        }
                    });
                }
            } else {
                userInfo.style.display = 'none';
                cartLink.style.display = 'none';
                adminLink.style.display = 'none';
                authLinks.innerHTML = `
                    <a href="#login">Iniciar Sesi√≥n</a>
                    <a href="#register">Registrarse</a>
                `;
            }
        });
    }
});

function logout() {
    if (typeof auth !== 'undefined') {
        auth.signOut();
    }
    srAnnounce('Sesi√≥n cerrada');
    window.location.hash = 'home';
}
</script>
</body>
</html>
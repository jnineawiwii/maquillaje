<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAC Style Makeup Store</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script src="js/firebase-config.js"></script>

    <style>
        /* Variables y Reset */
        :root {
            --primary-color: #e91e63;
            --secondary-color: #9c27b0;
            --accent-color: #ff4081;
            --text-color: #333;
            --light-bg: #f8f9fa;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --base-font-size: 16px;
            --base-line-height: 1.6;
            --site-header-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: var(--base-line-height);
            color: var(--text-color);
            padding-top: var(--site-header-height);
            font-size: var(--base-font-size);
            background-color: var(--light-bg);
            transition: all 0.3s ease;
        }

        /* Header */
        .navbar {
            background: var(--white);
            box-shadow: var(--shadow);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            height: var(--site-header-height);
            transition: all 0.3s ease;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }

        .logo h2 {
            color: var(--primary-color);
        }

        .logo a {
            text-decoration: none;
            color: inherit;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 30px;
            align-items: center;
        }

        .nav-menu a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-menu a:hover {
            color: var(--primary-color);
        }

        .cart-icon {
            position: relative;
        }

        .cart-count {
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            position: absolute;
            top: -8px;
            right: -8px;
        }

        /* ESTILOS PARA EL BUSCADOR MEJORADO */
        .search-container {
            flex: 1;
            max-width: 500px;
            margin: 0 20px;
        }

        .search-form {
            display: flex;
            width: 100%;
        }

        .search-form input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-right: none;
            border-radius: 25px 0 0 25px;
            font-size: 14px;
            outline: none;
        }

        .search-form input:focus {
            border-color: var(--primary-color);
        }

        .search-form button {
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }

        .voice-btn {
            background: var(--secondary-color);
            color: white;
            padding: 0 15px;
            border-left: 1px solid #e0e0e0;
        }

        .voice-btn:hover {
            background: #7b1fa2;
        }

        .search-btn {
            background: var(--primary-color);
            color: white;
            padding: 0 20px;
            border-radius: 0 25px 25px 0;
        }

        .search-btn:hover {
            background: #c2185b;
        }

        .voice-listening {
            background: var(--primary-color) !important;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Dropdown - MEJORADO PARA ACCESIBILIDAD */
        .dropdown {
            position: relative;
        }

        .dropdown-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px 12px;
            font-size: 1.2rem;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .dropdown-btn:hover,
        .dropdown-btn:focus {
            background: #f5f5f5;
            outline: 2px solid var(--primary-color);
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            box-shadow: var(--shadow);
            border-radius: 8px;
            padding: 10px;
            min-width: 280px;
            z-index: 1000;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-content a,
        .dropdown-content button {
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            padding: 10px 12px;
            text-decoration: none;
            color: var(--text-color);
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .dropdown-content a:hover,
        .dropdown-content a:focus,
        .dropdown-content button:hover,
        .dropdown-content button:focus {
            background: #f5f5f5;
            outline: 2px solid var(--primary-color);
        }

        /* Controles de accesibilidad */
        .accessibility-controls {
            padding: 10px 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            margin: 10px 0;
        }

        .accessibility-controls details {
            margin-bottom: 10px;
        }

        .accessibility-controls summary {
            cursor: pointer;
            font-weight: bold;
            padding: 5px 0;
            outline: none;
        }

        .accessibility-controls summary:focus {
            outline: 2px solid var(--primary-color);
            border-radius: 4px;
        }

        .accessibility-controls .control-group {
            margin-top: 10px;
            padding-left: 10px;
        }

        .accessibility-controls label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .accessibility-controls input[type="range"] {
            width: 100%;
            margin-bottom: 10px;
        }

        .accessibility-controls input[type="range"]:focus {
            outline: 2px solid var(--primary-color);
        }

        .accessibility-controls button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .accessibility-controls button:hover,
        .accessibility-controls button:focus {
            background: var(--accent-color);
            outline: 2px solid var(--primary-color);
        }

        /* ========== MODO OSCURO COMPLETO ========== */
        .dark-mode {
            background-color: #1a1a1a !important;
            color: #f0f0f0 !important;
        }

        .dark-mode .navbar {
            background: #2d2d2d !important;
        }

        .dark-mode .nav-menu a {
            color: #f0f0f0 !important;
        }

        .dark-mode .dropdown-content {
            background: #2d2d2d !important;
            color: #f0f0f0 !important;
        }

        .dark-mode .dropdown-content a,
        .dark-mode .dropdown-content button {
            color: #f0f0f0 !important;
        }

        .dark-mode .dropdown-content a:hover,
        .dark-mode .dropdown-content a:focus,
        .dark-mode .dropdown-content button:hover,
        .dark-mode .dropdown-content button:focus {
            background: #3d3d3d !important;
        }

        .dark-mode .dropdown-btn:hover,
        .dark-mode .dropdown-btn:focus {
            background: #3d3d3d !important;
        }

        .dark-mode .hero {
            background: linear-gradient(135deg, #2d2d2d, #1a1a1a) !important;
        }

        .dark-mode .products {
            background: #2d2d2d !important;
            color: #f0f0f0 !important;
        }

        .dark-mode .products h2 {
            color: #ff4081 !important;
        }

        .dark-mode .product-card {
            background: #3d3d3d !important;
            color: #f0f0f0 !important;
            border: 1px solid #555 !important;
        }

        .dark-mode .product-card h3 {
            color: #f0f0f0 !important;
        }

        .dark-mode .product-price {
            color: #ff4081 !important;
        }

        .dark-mode .search-results-info {
            background: #3d3d3d !important;
            color: #f0f0f0 !important;
            border-left-color: #ff4081 !important;
        }

        .dark-mode .no-results {
            color: #ccc !important;
        }

        .dark-mode .filters .filter-btn {
            background: #3d3d3d !important;
            color: #f0f0f0 !important;
            border: 1px solid #555 !important;
        }

        .dark-mode .filters .filter-btn.active {
            background: #e91e63 !important;
            color: white !important;
        }

        .dark-mode .filters .filter-btn:hover {
            background: #e91e63 !important;
            color: white !important;
        }

        .dark-mode .page-section {
            background: #2d2d2d !important;
            color: #f0f0f0 !important;
        }

        .dark-mode .container {
            color: #f0f0f0 !important;
        }

        /* ========== ALTO CONTRASTE ========== */
        .high-contrast {
            background: #000000 !important;
            color: #ffffff !important;
        }

        .high-contrast .navbar {
            background: #000000 !important;
            border-bottom: 3px solid #ffff00 !important;
        }

        .high-contrast .nav-menu a {
            color: #ffff00 !important;
        }

        .high-contrast .dropdown-content {
            background: #000000 !important;
            border: 2px solid #ffff00 !important;
        }

        .high-contrast a {
            color: #ffff00 !important;
        }

        .high-contrast .product-card {
            background: #000000 !important;
            border: 2px solid #ffff00 !important;
            color: #ffffff !important;
        }

        .high-contrast .products {
            background: #000000 !important;
        }

        .high-contrast .dropdown-btn:focus,
        .high-contrast button:focus,
        .high-contrast input:focus,
        .high-contrast summary:focus {
            outline: 3px solid #ffff00 !important;
        }

        /* Estilos para escala de grises */
        .grayscale {
            filter: grayscale(var(--grayscale-percent, 100%));
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 150px 0 100px;
            text-align: center;
            margin-top: 70px;
            transition: all 0.3s ease;
        }

        .hero-content h1 {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .hero-content p {
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .cta-button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 25px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .cta-button:hover {
            transform: translateY(-2px);
        }

        /* Products Section */
        .products {
            padding: 80px 0;
            background: var(--light-bg);
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .products h2 {
            text-align: center;
            margin-bottom: 50px;
            font-size: 2.5rem;
            color: var(--primary-color);
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
        }

        .product-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
        }

        .product-image {
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-card h3 {
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .product-price {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .add-to-cart {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .add-to-cart:hover {
            background: var(--accent-color);
        }

        /* Estilos para resultados de b√∫squeda */
        .search-results-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid var(--primary-color);
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
            grid-column: 1 / -1;
        }

        .no-results i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ccc;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: #f0f0f0;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .filter-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Page Sections */
        .page-section {
            padding: 40px 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        /* Estilos para accesibilidad */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .sr-announcement {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--primary-color);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            z-index: 9999;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .sr-announcement.show {
            opacity: 1;
        }

        /* Focus visible para todos los elementos interactivos */
        button:focus,
        input:focus,
        select:focus,
        textarea:focus,
        a:focus,
        summary:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Estilo para elementos enfocados con navegaci√≥n por voz */
        .voice-navigation-active {
            outline: 3px solid #4CAF50 !important;
            outline-offset: 3px !important;
            background-color: rgba(76, 175, 80, 0.1) !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-container {
                flex-wrap: wrap;
                height: auto;
                padding: 10px 20px;
            }

            .search-container {
                order: 3;
                flex: 1 1 100%;
                margin: 10px 0 0 0;
                max-width: none;
            }

            .nav-menu {
                gap: 15px;
            }

            .hero-content h1 {
                font-size: 2rem;
            }

            .product-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
                align-items: center;
            }

            .filter-btn {
                width: 200px;
            }

            .dropdown-content {
                min-width: 200px;
                right: -10px;
            }
        }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-container">
        <!-- Logo -->
        <div class="logo">
            <h2><a href="#home">MAC Style</a></h2>
        </div>

        <!-- Buscador Mejorado -->
        <div class="search-container">
            <form class="search-form" onsubmit="buscarProductos(event)">
                <input type="text" id="search-input" placeholder="Buscar productos..." value="">
                <button type="button" class="voice-btn" id="voice-search-btn" title="B√∫squeda por voz">
                    <i class="fas fa-microphone"></i>
                </button>
                <button type="submit" class="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </form>
        </div>

        <!-- Men√∫ de navegaci√≥n -->
        <ul class="nav-menu">
            <li id="admin-link" style="display: none;">
                <a href="#admin">Administraci√≥n</a>
            </li>
            
            <li><a href="#products">Productos</a></li>
            <li><a href="#products?category=labios">Labios</a></li>
            <li><a href="#products?category=ojos">Ojos</a></li>
            <li><a href="#products?category=rostro">Rostro</a></li>
            
            <li id="cart-link" style="display: none;">
                <a href="#cart" class="cart-icon">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count">0</span>
                </a>
            </li>
            
            <li id="user-info" style="display: none;">
                <span class="user-welcome" id="user-welcome"></span>
            </li>

            <!-- Men√∫ desplegable - MEJORADO PARA ACCESIBILIDAD -->
            <li class="dropdown">
                <button class="dropdown-btn" aria-expanded="false" aria-haspopup="true" aria-label="Men√∫ de opciones">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="dropdown-content" role="menu" aria-labelledby="dropdown-btn">
                    <a href="guide.html" role="menuitem">Gu√≠a de usuario</a>
                    
                    <div class="accessibility-controls">
                        <details>
                            <summary>Tama√±o de lectura</summary>
                            <div class="control-group">
                                <label for="fontSizeRange">
                                    <span>Fuente</span>
                                    <span id="fontSizeValue">16px</span>
                                </label>
                                <input id="fontSizeRange" type="range" min="12" max="28" step="1" value="16">
                                <button id="fontSizeReset">Restablecer</button>
                            </div>
                        </details>

                        <details>
                            <summary>Espaciado</summary>
                            <div class="control-group">
                                <label for="spacingRange">
                                    <span>Interlineado</span>
                                    <span id="spacingValue">1.6</span>
                                </label>
                                <input id="spacingRange" type="range" min="1.0" max="3.0" step="0.1" value="1.6">
                                <button id="spacingReset">Restablecer</button>
                            </div>
                        </details>

                        <button id="toggleContrastBtn">Alto contraste</button>

                        <details>
                            <summary>Escala de grises</summary>
                            <div class="control-group">
                                <label for="grayscaleRange">
                                    <span>Intensidad</span>
                                    <span id="grayscaleValue">0%</span>
                                </label>
                                <input id="grayscaleRange" type="range" min="0" max="100" step="1" value="0">
                                <button id="grayscaleReset">Restablecer</button>
                            </div>
                        </details>
                    </div>

                    <button id="srToggleBtnMenu" role="menuitem">Navegaci√≥n por voz</button>
                    <button id="themeToggleBtnMenu" role="menuitem">Cambiar a modo oscuro</button>
                    
                    <div id="auth-links">
                        <a href="#login" role="menuitem">Iniciar Sesi√≥n</a>
                        <a href="#register" role="menuitem">Registrarse</a>
                    </div>
                </div>
            </li>
        </ul>
    </div>
</nav>

<main id="main-content">
    <div id="page-content">
        <!-- Contenido se cargar√° din√°micamente aqu√≠ -->
    </div>
</main>

<div id="sr-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>
<div id="sr-visual-announcer" class="sr-announcement" aria-hidden="true"></div>

<script>
// ====================================================================
// SISTEMA DE RUTAS
// ====================================================================
function cargarPagina(pagina, parametros = {}) {
    const contenido = document.getElementById('page-content');
    
    switch(pagina) {
        case 'home':
            contenido.innerHTML = `
                <section class="hero">
                    <div class="hero-content">
                        <h1>Bienvenido a MAC Style</h1>
                        <p>Descubre la mejor colecci√≥n de maquillaje profesional</p>
                        <a href="#products" class="cta-button">Ver Productos</a>
                    </div>
                </section>
                <section class="products">
                    <div class="container">
                        <h2>Ofertas Especiales</h2>
                        <p style="text-align: center; font-size: 1.2rem; margin-bottom: 30px;">Hasta 50% de descuento en productos seleccionados</p>
                        <div class="product-grid">
                            <div class="product-card">
                                <div class="product-image">
                                    <i class="fas fa-gift" style="font-size: 4rem; color: #e91e63;"></i>
                                </div>
                                <h3>Kit Maquillaje Completo</h3>
                                <p>Todo lo que necesitas en un solo kit</p>
                                <div class="product-price">$599 MXN</div>
                                <button class="add-to-cart">Ver Oferta</button>
                            </div>
                        </div>
                    </div>
                </section>
            `;
            break;
            
        case 'products':
            const categoria = parametros.category || 'all';
            const terminoBusqueda = parametros.search || '';
            contenido.innerHTML = `
                <section class="products">
                    <div class="container">
                        <h2>Nuestros Productos</h2>
                        <div class="filters">
                            <button onclick="filtrarProductos('all')" class="filter-btn ${categoria === 'all' ? 'active' : ''}">
                                Todos
                            </button>
                            <button onclick="filtrarProductos('labios')" class="filter-btn ${categoria === 'labios' ? 'active' : ''}">
                                Labios
                            </button>
                            <button onclick="filtrarProductos('ojos')" class="filter-btn ${categoria === 'ojos' ? 'active' : ''}">
                                Ojos
                            </button>
                            <button onclick="filtrarProductos('rostro')" class="filter-btn ${categoria === 'rostro' ? 'active' : ''}">
                                Rostro
                            </button>
                        </div>
                        ${terminoBusqueda ? `
                            <div class="search-results-info">
                                <h3>Resultados de b√∫squeda para: <strong>"${terminoBusqueda}"</strong></h3>
                            </div>
                        ` : ''}
                        <div id="products-grid" class="product-grid"></div>
                    </div>
                </section>
            `;
            cargarProductos(categoria, terminoBusqueda);
            break;
            
        case 'cart':
            contenido.innerHTML = `
                <section class="products">
                    <div class="container">
                        <h2>Tu Carrito de Compras</h2>
                        <div id="cart-items"></div>
                        <div class="cart-total">
                            Total: $<span id="total-price">0.00</span> MXN
                        </div>
                        <button class="checkout-btn" onclick="redirigirACheckout()">Proceder al Pago</button>
                    </div>
                </section>
            `;
            mostrarCarrito();
            break;
            
        case 'checkout':
            contenido.innerHTML = `
                <section class="page-section">
                    <h1>Proceso de Pago</h1>
                    <iframe src="checkout.html" class="page-iframe" title="Proceso de pago Mercado Pago" 
                            style="width: 100%; height: 600px; border: none; border-radius: 8px;"></iframe>
                </section>
            `;
            break;
            
        case 'guide':
        case 'login':
        case 'register':
            const titleMap = {
                'guide': 'Gu√≠a de Usuario',
                'login': 'Iniciar Sesi√≥n',
                'register': 'Registrarse'
            };
            const pageTitle = titleMap[pagina] || pagina;

            contenido.innerHTML = `
                <section class="page-section">
                    <h1>${pageTitle}</h1>
                    <iframe src="${pagina}.html" class="page-iframe" title="${pageTitle}"
                            style="width: 100%; height: 600px; border: none; border-radius: 8px;"></iframe>
                </section>
            `;
            break;
            
        default:
            cargarPagina('home');
    }
}

// ====================================================================
// FUNCIONES DE PRODUCTOS
// ====================================================================
async function cargarProductos(categoria = 'all', terminoBusqueda = '') {
    try {
        console.log('üîÑ Cargando productos...', categoria, terminoBusqueda);
        
        if (typeof db === 'undefined') {
            console.error('‚ùå Firestore no est√° inicializado');
            mostrarProductos([]);
            return;
        }
        
        let query = db.collection('products');
        
        if (categoria !== 'all') {
            query = query.where('category', '==', categoria);
        }
        
        const snapshot = await query.get();
        let productos = [];
        
        snapshot.forEach(doc => {
            const data = doc.data();
            productos.push({ 
                id: doc.id, 
                name: data.name,
                description: data.description,
                price: data.price,
                category: data.category,
                imageUrl: data.image || data.imageUrl
            });
        });
        
        // Filtrar por t√©rmino de b√∫squeda
        if (terminoBusqueda) {
            const termino = terminoBusqueda.toLowerCase();
            productos = productos.filter(producto => 
                producto.name.toLowerCase().includes(termino) ||
                producto.description.toLowerCase().includes(termino) ||
                producto.category.toLowerCase().includes(termino)
            );
        }
        
        console.log(`‚úÖ ${productos.length} productos cargados`);
        mostrarProductos(productos);
        
    } catch (error) {
        console.error('‚ùå Error cargando productos:', error);
        mostrarProductos([]);
    }
}

function mostrarProductos(productos) {
    const grid = document.getElementById('products-grid');
    
    if (!grid) return;
    
    if (productos.length === 0) {
        grid.innerHTML = `
            <div class="no-results">
                <i class="fas fa-search"></i>
                <h3>No se encontraron productos</h3>
                <p>Intenta con otros t√©rminos de b√∫squeda o categor√≠as</p>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = productos.map(producto => `
        <div class="product-card">
            <div class="product-image">
                <img src="${producto.imageUrl}" 
                     alt="${producto.name}"
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+SW1hZ2VuIG5vIGRpc3BvbmlibGU8L3RleHQ+PC9zdmc+'">
            </div>
            <h3>${producto.name}</h3>
            <p>${producto.description}</p>
            <div class="product-price">$${producto.price} MXN</div>
            <button class="add-to-cart" onclick="agregarAlCarrito('${producto.id}', '${producto.name.replace(/'/g, "\\'")}', ${producto.price}, '${producto.category}')">
                <i class="fas fa-cart-plus"></i> Agregar al Carrito
            </button>
        </div>
    `).join('');
}

function filtrarProductos(categoria) {
    console.log('üîç Filtrando por categor√≠a:', categoria);
    window.location.hash = `products${categoria !== 'all' ? `?category=${categoria}` : ''}`;
}

// ====================================================================
// B√öSQUEDA POR VOZ - VERSI√ìN CORREGIDA
// ====================================================================
// ====================================================================
// B√öSQUEDA POR VOZ - VERSI√ìN CORREGIDA Y MEJORADA
// ====================================================================
let recognition = null;
let isListening = false;

function inicializarReconocimientoVoz() {
    console.log('üé§ Inicializando reconocimiento de voz...');
    
    // Verificar compatibilidad
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        console.warn('‚ùå El reconocimiento de voz no es compatible con este navegador');
        const voiceBtn = document.getElementById('voice-search-btn');
        if (voiceBtn) {
            voiceBtn.style.display = 'none';
            voiceBtn.disabled = true;
        }
        return;
    }
    
    try {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'es-ES';
        recognition.maxAlternatives = 1;
        
        recognition.onstart = function() {
            console.log('üé§ Reconocimiento de voz iniciado');
            isListening = true;
            const voiceBtn = document.getElementById('voice-search-btn');
            if (voiceBtn) {
                voiceBtn.classList.add('voice-listening');
                voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                voiceBtn.title = "Click para detener";
            }
            srAnnounce('Escuchando... Habla ahora', 'assertive');
        };
        
        recognition.onresult = function(event) {
            console.log('üé§ Resultado recibido:', event);
            
            if (event.results.length > 0 && event.results[0].length > 0) {
                let transcript = event.results[0][0].transcript;
                
                console.log('Texto reconocido (original):', transcript);
                
                // LIMPIEZA MEJORADA DEL TEXTO
                transcript = transcript
                    .trim()
                    .replace(/\.+$/, '') // Eliminar uno o m√°s puntos al final
                    .replace(/\s+\.$/, '') // Eliminar punto despu√©s de espacios
                    .replace(/\s+/g, ' ') // Normalizar espacios m√∫ltiples
                    .replace(/^\s+|\s+$/g, ''); // Eliminar espacios al inicio y final
                
                console.log('Texto reconocido (limpio):', transcript);
                
                const searchInput = document.getElementById('search-input');
                if (searchInput && transcript) {
                    searchInput.value = transcript;
                    searchInput.focus();
                    srAnnounce(`B√∫squeda por voz: "${transcript}"`, 'polite');
                    
                    // Ejecutar b√∫squeda autom√°ticamente
                    setTimeout(() => {
                        buscarProductos(new Event('submit'));
                    }, 800);
                }
            }
        };
        
        recognition.onerror = function(event) {
            console.error('‚ùå Error en reconocimiento de voz:', event.error);
            
            let errorMsg = 'Error en el reconocimiento de voz';
            switch(event.error) {
                case 'not-allowed':
                case 'permission-denied':
                    errorMsg = 'Permiso de micr√≥fono denegado. Por favor, permite el acceso al micr√≥fono.';
                    break;
                case 'network':
                    errorMsg = 'Error de red en el reconocimiento de voz';
                    break;
                case 'no-speech':
                    errorMsg = 'No se detect√≥ voz. Intenta nuevamente.';
                    break;
            }
            
            srAnnounce(errorMsg, 'assertive');
            resetVoiceButton();
        };
        
        recognition.onend = function() {
            console.log('üé§ Reconocimiento de voz finalizado');
            isListening = false;
            resetVoiceButton();
        };
        
        console.log('‚úÖ Reconocimiento de voz inicializado correctamente');
        
    } catch (error) {
        console.error('‚ùå Error al inicializar reconocimiento de voz:', error);
        srAnnounce('Error al inicializar el reconocimiento de voz', 'assertive');
    }
}

function resetVoiceButton() {
    const voiceBtn = document.getElementById('voice-search-btn');
    if (voiceBtn) {
        voiceBtn.classList.remove('voice-listening');
        voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        voiceBtn.title = "B√∫squeda por voz";
    }
}

function toggleReconocimientoVoz() {
    console.log('üé§ Click en bot√≥n de voz, estado actual:', isListening);
    
    if (!recognition) {
        console.log('üé§ Inicializando reconocimiento por primera vez...');
        inicializarReconocimientoVoz();
    }
    
    if (!recognition) {
        console.error('‚ùå No se pudo inicializar el reconocimiento de voz');
        srAnnounce('El reconocimiento de voz no est√° disponible', 'assertive');
        return;
    }
    
    try {
        if (isListening) {
            console.log('üé§ Deteniendo reconocimiento...');
            recognition.stop();
        } else {
            console.log('üé§ Iniciando reconocimiento...');
            // Solicitar permiso de micr√≥fono primero
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(stream) {
                        // Permiso concedido, iniciar reconocimiento
                        recognition.start();
                        // Detener el stream ya que no lo necesitamos directamente
                        stream.getTracks().forEach(track => track.stop());
                    })
                    .catch(function(err) {
                        console.error('‚ùå Error al acceder al micr√≥fono:', err);
                        srAnnounce('No se pudo acceder al micr√≥fono. Por favor, verifica los permisos.', 'assertive');
                    });
            } else {
                // Navegador m√°s antiguo, intentar directamente
                recognition.start();
            }
        }
    } catch (error) {
        console.error('‚ùå Error al controlar reconocimiento de voz:', error);
        srAnnounce('Error al iniciar el reconocimiento de voz', 'assertive');
    }
}

// ====================================================================
// BUSCADOR MEJORADO CON LIMPIEZA
// ====================================================================
function buscarProductos(event) {
    if (event) event.preventDefault();
    
    let termino = document.getElementById('search-input').value.trim();
    
    // Limpieza adicional por si el usuario escribe con punto
    termino = termino.replace(/\.$/, '').trim();
    
    if (termino) {
        console.log('üîç Buscando:', termino);
        srAnnounce(`Buscando: "${termino}"`);
        window.location.hash = `products?search=${encodeURIComponent(termino)}`;
    } else {
        window.location.hash = 'products';
    }
}

// ====================================================================
// FUNCIONES DEL CARRITO
// ====================================================================
function agregarAlCarrito(id, nombre, precio, categoria = 'General') {
    let carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    const existe = carrito.find(item => item.id === id);
    
    if (existe) {
        existe.cantidad++;
    } else {
        carrito.push({ 
            id, 
            nombre, 
            precio: parseFloat(precio), 
            cantidad: 1,
            categoria: categoria
        });
    }
    
    localStorage.setItem('carrito', JSON.stringify(carrito));
    actualizarContadorCarrito();
    
    const cartCount = document.querySelector('.cart-count');
    if (cartCount) {
        cartCount.classList.add('bump');
        setTimeout(() => cartCount.classList.remove('bump'), 200);
    }
    
    srAnnounce(`${nombre} agregado al carrito`);
}

function actualizarContadorCarrito() {
    const carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    const total = carrito.reduce((sum, item) => sum + item.cantidad, 0);
    const cartCountEl = document.querySelector('.cart-count');
    if (cartCountEl) {
        cartCountEl.textContent = total;
    }
}

function mostrarCarrito() {
    const carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    const itemsDiv = document.getElementById('cart-items');
    const totalDiv = document.getElementById('total-price');
    
    if (!itemsDiv || !totalDiv) return;

    if (carrito.length === 0) {
        itemsDiv.innerHTML = '<p>Tu carrito est√° vac√≠o</p>';
        totalDiv.textContent = '0.00';
        return;
    }
    
    let total = 0;
    itemsDiv.innerHTML = carrito.map(item => {
        const subtotal = item.precio * item.cantidad;
        total += subtotal;
        return `
            <div class="cart-item">
                <div class="cart-item-info">
                    <h3>${item.nombre}</h3>
                    <p>Precio: $${item.precio.toFixed(2)} x ${item.cantidad} = $${subtotal.toFixed(2)}</p>
                </div>
                <div class="cart-item-actions">
                    <button onclick="cambiarCantidad('${item.id}', ${item.cantidad - 1})">-</button>
                    <span>${item.cantidad}</span>
                    <button onclick="cambiarCantidad('${item.id}', ${item.cantidad + 1})">+</button>
                    <button onclick="removerDelCarrito('${item.id}')">Eliminar</button>
                </div>
            </div>
        `;
    }).join('');
    
    totalDiv.textContent = total.toFixed(2);
}

function cambiarCantidad(id, nuevaCantidad) {
    if (nuevaCantidad < 1) {
        removerDelCarrito(id);
        return;
    }
    
    let carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    const item = carrito.find(item => item.id === id);
    
    if (item) {
        item.cantidad = nuevaCantidad;
        localStorage.setItem('carrito', JSON.stringify(carrito));
        mostrarCarrito();
        actualizarContadorCarrito();
    }
}

function removerDelCarrito(id) {
    let carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    const itemNombre = carrito.find(item => item.id === id)?.nombre || 'Producto';
    carrito = carrito.filter(item => item.id !== id);
    localStorage.setItem('carrito', JSON.stringify(carrito));
    mostrarCarrito();
    actualizarContadorCarrito();
    srAnnounce(`${itemNombre} eliminado del carrito`);
}

function redirigirACheckout() {
    const carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    
    if (carrito.length === 0) {
        srAnnounce('Tu carrito est√° vac√≠o, no puedes pagar');
        alert('Tu carrito est√° vac√≠o');
        return;
    }
    
    window.location.hash = 'checkout';
    srAnnounce('Redirigiendo al proceso de pago');
}

// ====================================================================
// NAVEGACI√ìN POR VOZ AUTOM√ÅTICA - LECTOR DE PANTALLA
// ====================================================================
let speechSynthesis = window.speechSynthesis;
let isVoiceNavigationActive = false;
let lastFocusedElement = null;

function inicializarNavegacionPorVoz() {
    console.log('üéØ Inicializando navegaci√≥n por voz autom√°tica...');
    
    // Verificar compatibilidad
    if (!('speechSynthesis' in window)) {
        console.warn('‚ùå La s√≠ntesis de voz no es compatible con este navegador');
        const srToggleBtnMenu = document.getElementById('srToggleBtnMenu');
        if (srToggleBtnMenu) {
            srToggleBtnMenu.style.display = 'none';
            srToggleBtnMenu.disabled = true;
        }
        return;
    }
    
    console.log('‚úÖ Navegaci√≥n por voz disponible');
}

function toggleNavegacionPorVoz() {
    if (!isVoiceNavigationActive) {
        activarNavegacionPorVoz();
    } else {
        desactivarNavegacionPorVoz();
    }
}

function activarNavegacionPorVoz() {
    console.log('üîä Activando navegaci√≥n por voz autom√°tica');
    isVoiceNavigationActive = true;
    
    const btn = document.getElementById('srToggleBtnMenu');
    if (btn) {
        btn.textContent = 'Desactivar navegaci√≥n por voz';
        btn.classList.add('active');
    }
    
    // Agregar event listeners para focus
    document.addEventListener('focusin', manejarFocusEnElemento);
    document.addEventListener('mouseover', manejarMouseOverElemento);
    
    srAnnounce('Navegaci√≥n por voz activada. Al mover el cursor o usar tabulador, se anunciar√° cada elemento.', 'assertive');
    
    // Anunciar elemento actualmente enfocado
    if (document.activeElement) {
        setTimeout(() => {
            anunciarElemento(document.activeElement);
        }, 500);
    }
}

function desactivarNavegacionPorVoz() {
    console.log('üîá Desactivando navegaci√≥n por voz');
    isVoiceNavigationActive = false;
    
    const btn = document.getElementById('srToggleBtnMenu');
    if (btn) {
        btn.textContent = 'Navegaci√≥n por voz';
        btn.classList.remove('active');
    }
    
    // Remover event listeners
    document.removeEventListener('focusin', manejarFocusEnElemento);
    document.removeEventListener('mouseover', manejarMouseOverElemento);
    
    // Remover estilos de navegaci√≥n activa
    document.querySelectorAll('.voice-navigation-active').forEach(el => {
        el.classList.remove('voice-navigation-active');
    });
    
    srAnnounce('Navegaci√≥n por voz desactivada', 'assertive');
}

function manejarFocusEnElemento(event) {
    if (!isVoiceNavigationActive) return;
    
    const elemento = event.target;
    
    // Evitar anunciar el mismo elemento repetidamente
    if (elemento === lastFocusedElement) return;
    
    lastFocusedElement = elemento;
    
    // Remover estilos previos
    document.querySelectorAll('.voice-navigation-active').forEach(el => {
        el.classList.remove('voice-navigation-active');
    });
    
    // Aplicar estilo al elemento actual
    elemento.classList.add('voice-navigation-active');
    
    // Anunciar el elemento despu√©s de un peque√±o delay
    setTimeout(() => {
        anunciarElemento(elemento);
    }, 100);
}

function manejarMouseOverElemento(event) {
    if (!isVoiceNavigationActive) return;
    
    const elemento = event.target;
    
    // Solo anunciar elementos interactivos o importantes
    if (esElementoImportante(elemento)) {
        // Remover estilos previos
        document.querySelectorAll('.voice-navigation-active').forEach(el => {
            el.classList.remove('voice-navigation-active');
        });
        
        // Aplicar estilo al elemento actual
        elemento.classList.add('voice-navigation-active');
        
        // Anunciar el elemento
        anunciarElemento(elemento);
    }
}

function esElementoImportante(elemento) {
    const tagName = elemento.tagName.toLowerCase();
    const roles = elemento.getAttribute('role');
    const tipos = [
        'button', 'link', 'heading', 'navigation', 'main', 
        'form', 'search', 'banner', 'contentinfo'
    ];
    
    return (
        ['a', 'button', 'input', 'select', 'textarea', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'].includes(tagName) ||
        (roles && tipos.some(tipo => roles.includes(tipo))) ||
        elemento.hasAttribute('aria-label') ||
        elemento.hasAttribute('alt') ||
        elemento.classList.contains('product-card') ||
        elemento.classList.contains('filter-btn') ||
        elemento.classList.contains('add-to-cart')
    );
}

function anunciarElemento(elemento) {
    if (!isVoiceNavigationActive) return;
    
    let textoAnuncio = obtenerTextoParaAnunciar(elemento);
    
    if (!textoAnuncio) return;
    
    // Detener cualquier anuncio previo
    if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
    }
    
    const utterance = new SpeechSynthesisUtterance(textoAnuncio);
    utterance.lang = 'es-ES';
    utterance.rate = 0.9;
    utterance.volume = 0.8;
    utterance.pitch = 1;
    
    // Configurar voz en espa√±ol si est√° disponible
    const voices = speechSynthesis.getVoices();
    const spanishVoice = voices.find(voice => 
        voice.lang.includes('es') || voice.lang.includes('ES')
    );
    
    if (spanishVoice) {
        utterance.voice = spanishVoice;
    }
    
    utterance.onerror = function(event) {
        console.error('Error anunciando elemento:', event);
    };
    
    speechSynthesis.speak(utterance);
}

function obtenerTextoParaAnunciar(elemento) {
    const tagName = elemento.tagName.toLowerCase();
    const texto = elemento.textContent?.trim() || '';
    const ariaLabel = elemento.getAttribute('aria-label');
    const alt = elemento.getAttribute('alt');
    const placeholder = elemento.getAttribute('placeholder');
    const type = elemento.getAttribute('type');
    const role = elemento.getAttribute('role');
    
    // Priorizar aria-label
    if (ariaLabel) return ariaLabel;
    
    // Para im√°genes
    if (tagName === 'img' && alt) return `Imagen: ${alt}`;
    
    // Para inputs
    if (tagName === 'input') {
        if (type === 'search' || type === 'text') {
            return `Campo de b√∫squeda: ${placeholder || 'buscar'}`;
        }
        if (type === 'button') {
            return texto || 'Bot√≥n';
        }
    }
    
    // Para botones
    if (tagName === 'button' || role === 'button') {
        if (texto.includes('üõí') || texto.includes('carrito')) {
            return `Carrito de compras: ${obtenerTextoCarrito()}`;
        }
        if (texto.includes('üîç') || texto.includes('buscar')) {
            return 'Bot√≥n de b√∫squeda';
        }
        return texto || 'Bot√≥n';
    }
    
    // Para enlaces
    if (tagName === 'a' || role === 'link') {
        if (texto.includes('Productos')) return 'Enlace a productos';
        if (texto.includes('Labios')) return 'Enlace a productos de labios';
        if (texto.includes('Ojos')) return 'Enlace a productos de ojos';
        if (texto.includes('Rostro')) return 'Enlace a productos de rostro';
        if (texto.includes('Iniciar')) return 'Enlace para iniciar sesi√≥n';
        if (texto.includes('Registrarse')) return 'Enlace para registrarse';
        return `Enlace: ${texto}`;
    }
    
    // Para encabezados
    if (tagName.startsWith('h')) {
        return `Encabezado: ${texto}`;
    }
    
    // Para productos
    if (elemento.classList.contains('product-card')) {
        const nombre = elemento.querySelector('h3')?.textContent || '';
        const precio = elemento.querySelector('.product-price')?.textContent || '';
        return `Producto: ${nombre}. Precio: ${precio}`;
    }
    
    // Para botones de filtro
    if (elemento.classList.contains('filter-btn')) {
        const estado = elemento.classList.contains('active') ? 'activo' : 'inactivo';
        return `Filtro ${texto}: ${estado}`;
    }
    
    // Texto general (limitar longitud)
    if (texto && texto.length > 0 && texto.length < 100) {
        return texto;
    }
    
    return null;
}

function obtenerTextoCarrito() {
    const carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    const total = carrito.reduce((sum, item) => sum + item.cantidad, 0);
    return total === 0 ? 'carrito vac√≠o' : `${total} productos en el carrito`;
}

// ====================================================================
// ACCESIBILIDAD CON TECLADO - DROPDOWN MEJORADO
// ====================================================================
function inicializarDropdownAccesible() {
    const dropdownBtn = document.querySelector('.dropdown-btn');
    const dropdownContent = document.querySelector('.dropdown-content');
    
    if (!dropdownBtn || !dropdownContent) return;
    
    // Funci√≥n para abrir/cerrar dropdown
    function toggleDropdown() {
        const isOpen = dropdownContent.classList.contains('show');
        dropdownContent.classList.toggle('show');
        dropdownBtn.setAttribute('aria-expanded', !isOpen);
        
        if (!isOpen) {
            // Enfocar el primer elemento del dropdown cuando se abre
            const firstItem = dropdownContent.querySelector('a, button');
            if (firstItem) {
                setTimeout(() => firstItem.focus(), 100);
            }
        }
    }
    
    // Evento click
    dropdownBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleDropdown();
    });
    
    // Evento teclado - Enter y Space
    dropdownBtn.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggleDropdown();
        } else if (e.key === 'Escape' && dropdownContent.classList.contains('show')) {
            toggleDropdown();
            dropdownBtn.focus();
        }
    });
    
    // Navegaci√≥n con teclado dentro del dropdown
    dropdownContent.addEventListener('keydown', function(e) {
        const items = Array.from(dropdownContent.querySelectorAll('a, button, input, summary'));
        const currentIndex = items.indexOf(document.activeElement);
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                const nextIndex = (currentIndex + 1) % items.length;
                items[nextIndex].focus();
                break;
                
            case 'ArrowUp':
                e.preventDefault();
                const prevIndex = (currentIndex - 1 + items.length) % items.length;
                items[prevIndex].focus();
                break;
                
            case 'Escape':
                e.preventDefault();
                toggleDropdown();
                dropdownBtn.focus();
                break;
                
            case 'Tab':
                if (!e.shiftKey && currentIndex === items.length - 1) {
                    // √öltimo elemento, cerrar dropdown
                    setTimeout(() => {
                        toggleDropdown();
                    }, 10);
                }
                break;
        }
    });
    
    // Cerrar dropdown al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!dropdownBtn.contains(e.target) && !dropdownContent.contains(e.target)) {
            dropdownContent.classList.remove('show');
            dropdownBtn.setAttribute('aria-expanded', 'false');
        }
    });
    
    // Cerrar dropdown cuando un enlace es clickeado
    dropdownContent.addEventListener('click', function(e) {
        if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
            setTimeout(() => {
                dropdownContent.classList.remove('show');
                dropdownBtn.setAttribute('aria-expanded', 'false');
            }, 300);
        }
    });
}

// ====================================================================
// FUNCIONES DE ACCESIBILIDAD
// ====================================================================
function srAnnounce(msg, politeness = 'polite', visualFeedback = true) {
    const el = document.getElementById('sr-announcer');
    if (el) {
        el.setAttribute('aria-live', politeness);
        el.textContent = '';
        setTimeout(() => el.textContent = msg, 100);
    }
    
    if (visualFeedback) {
        const visualEl = document.getElementById('sr-visual-announcer');
        if (visualEl) {
            visualEl.textContent = msg;
            visualEl.classList.add('show');
            setTimeout(() => {
                visualEl.classList.remove('show');
            }, 3000);
        }
    }
}

// ====================================================================
// CONTROLES DE ACCESIBILIDAD MEJORADOS
// ====================================================================
function inicializarControlesAccesibilidad() {
    // Tama√±o de fuente
    const fontSizeRange = document.getElementById('fontSizeRange');
    const fontSizeValue = document.getElementById('fontSizeValue');
    const fontSizeReset = document.getElementById('fontSizeReset');
    
    if (fontSizeRange) {
        fontSizeRange.addEventListener('input', function() {
            const newSize = this.value + 'px';
            document.documentElement.style.fontSize = newSize;
            fontSizeValue.textContent = newSize;
            srAnnounce(`Tama√±o de fuente cambiado a ${newSize}`);
        });
        
        fontSizeReset.addEventListener('click', function() {
            fontSizeRange.value = 16;
            document.documentElement.style.fontSize = '16px';
            fontSizeValue.textContent = '16px';
            srAnnounce('Tama√±o de fuente restablecido');
        });
    }
    
    // ESPACIADO CORREGIDO
    const spacingRange = document.getElementById('spacingRange');
    const spacingValue = document.getElementById('spacingValue');
    const spacingReset = document.getElementById('spacingReset');
    
    if (spacingRange) {
        spacingRange.addEventListener('input', function() {
            const newSpacing = this.value;
            document.documentElement.style.setProperty('--base-line-height', newSpacing);
            spacingValue.textContent = newSpacing;
            srAnnounce(`Interlineado cambiado a ${newSpacing}`);
        });
        
        spacingReset.addEventListener('click', function() {
            spacingRange.value = 1.6;
            document.documentElement.style.setProperty('--base-line-height', '1.6');
            spacingValue.textContent = '1.6';
            srAnnounce('Interlineado restablecido');
        });
    }
    
    // Alto contraste
    const toggleContrastBtn = document.getElementById('toggleContrastBtn');
    
    if (toggleContrastBtn) {
        toggleContrastBtn.addEventListener('click', function() {
            document.body.classList.toggle('high-contrast');
            const isActive = document.body.classList.contains('high-contrast');
            this.textContent = isActive ? 'Desactivar alto contraste' : 'Alto contraste';
            srAnnounce(isActive ? 'Alto contraste activado' : 'Alto contraste desactivado');
        });
    }
    
    // Escala de grises
    const grayscaleRange = document.getElementById('grayscaleRange');
    const grayscaleValue = document.getElementById('grayscaleValue');
    const grayscaleReset = document.getElementById('grayscaleReset');
    
    if (grayscaleRange) {
        grayscaleRange.addEventListener('input', function() {
            document.documentElement.style.setProperty('--grayscale-percent', this.value + '%');
            grayscaleValue.textContent = this.value + '%';
            document.body.classList.toggle('grayscale', this.value > 0);
            srAnnounce(`Escala de grises al ${this.value}%`);
        });
        
        grayscaleReset.addEventListener('click', function() {
            grayscaleRange.value = 0;
            document.documentElement.style.setProperty('--grayscale-percent', '0%');
            grayscaleValue.textContent = '0%';
            document.body.classList.remove('grayscale');
            srAnnounce('Escala de grises restablecida');
        });
    }
    
    // NAVEGACI√ìN POR VOZ AUTOM√ÅTICA
    const srToggleBtnMenu = document.getElementById('srToggleBtnMenu');

    if (srToggleBtnMenu) {
        // Verificar compatibilidad primero
        if (!('speechSynthesis' in window)) {
            srToggleBtnMenu.style.display = 'none';
            console.warn('‚ùå Navegaci√≥n por voz no compatible');
        } else {
            // Event listener mejorado
            srToggleBtnMenu.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('üéØ Activando/desactivando navegaci√≥n por voz');
                toggleNavegacionPorVoz();
            });
            
            // Tambi√©n permitir Enter/Space para accesibilidad
            srToggleBtnMenu.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    console.log('üéØ Tecla Enter/Space en bot√≥n navegaci√≥n por voz');
                    toggleNavegacionPorVoz();
                }
            });
            
            console.log('‚úÖ Navegaci√≥n por voz inicializada correctamente');
        }
    }
    
    // Modo oscuro
    const themeToggleBtnMenu = document.getElementById('themeToggleBtnMenu');
    
    if (themeToggleBtnMenu) {
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            themeToggleBtnMenu.textContent = 'Cambiar a modo claro';
        }
        
        themeToggleBtnMenu.addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            this.textContent = isDark ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro';
            localStorage.setItem('darkMode', isDark);
            srAnnounce(isDark ? 'Modo oscuro activado' : 'Modo claro activado');
        });
    }
}

// ====================================================================
// INICIALIZACI√ìN
// ====================================================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando aplicaci√≥n...');
    
    // Sistema de rutas
    window.addEventListener('hashchange', function() {
        const hash = window.location.hash.substring(1);
        let pagina = 'home';
        let parametros = {};
        
        if (hash.includes('?')) {
            const parts = hash.split('?');
            pagina = parts[0];
            const searchParams = new URLSearchParams(parts[1]);
            parametros = Object.fromEntries(searchParams.entries());
        } else if (hash) {
            pagina = hash;
        }
        
        cargarPagina(pagina, parametros);
        const voiceBtn = document.getElementById('voice-search-btn');
    if (voiceBtn) {
        voiceBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('üé§ Bot√≥n de voz clickeado');
            toggleReconocimientoVoz();
        });
        
        // Tambi√©n permitir activar con Enter/Space para accesibilidad
        voiceBtn.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggleReconocimientoVoz();
            }
        });
    }
    });
    
    // Cargar p√°gina inicial
    const hash = window.location.hash.substring(1);
    if (!hash) {
        cargarPagina('home');
    } else {
        window.dispatchEvent(new Event('hashchange'));
    }
    
    // Inicializar componentes
    actualizarContadorCarrito();
    inicializarReconocimientoVoz();
    inicializarControlesAccesibilidad();
    inicializarNavegacionPorVoz();
    inicializarDropdownAccesible();

    console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
    
    // Auth state
    if (typeof auth !== 'undefined') {
        auth.onAuthStateChanged(usuario => {
            const userInfo = document.getElementById('user-info');
            const authLinks = document.getElementById('auth-links');
            const cartLink = document.getElementById('cart-link');
            const adminLink = document.getElementById('admin-link');
            
            if (usuario) {
                userInfo.style.display = 'block';
                cartLink.style.display = 'block';
                document.getElementById('user-welcome').textContent = `Hola, ${usuario.email}`;
                authLinks.innerHTML = '<a href="#" onclick="logout()">Cerrar Sesi√≥n</a>';
                
                if (typeof db !== 'undefined') {
                    db.collection('users').doc(usuario.uid).get().then(doc => {
                        if (doc.exists && doc.data().role === 'admin') {
                            adminLink.style.display = 'block';
                        }
                    });
                }
            } else {
                userInfo.style.display = 'none';
                cartLink.style.display = 'none';
                adminLink.style.display = 'none';
                authLinks.innerHTML = `
                    <a href="#login">Iniciar Sesi√≥n</a>
                    <a href="#register">Registrarse</a>
                `;
            }
        });
    }
});

function logout() {
    if (typeof auth !== 'undefined') {
        auth.signOut();
    }
    srAnnounce('Sesi√≥n cerrada');
    window.location.hash = 'home';
}
</script>
</body>
</html>
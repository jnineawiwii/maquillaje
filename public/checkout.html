<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Proceso de Pago | MAC Style</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .checkout-container {
            max-width: 800px;
            margin: 30px auto;
            padding: 30px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .checkout-container h1 {
            color: #7b1fa2;
            margin-bottom: 20px;
            text-align: center;
            font-size: 2rem;
        }

        .payment-content {
            padding: 25px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin: 20px 0;
            background: #f8f9fa;
        }
        
        .payment-content p {
            font-size: 1.1rem;
            color: #555;
            margin-bottom: 10px;
        }
        
        /* Botón de Mercado Pago */
        .btn-mp {
            background-color: #009EE3;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            margin: 20px auto;
            transition: background-color 0.3s;
            font-weight: bold;
            display: block;
            text-align: center;
            width: 100%;
            max-width: 300px;
        }
        
        .btn-mp:hover {
            background-color: #008cd4;
            transform: translateY(-2px);
        }
        
        .btn-mp i {
            margin-right: 10px;
        }

        .back-to-cart {
            margin-top: 30px;
            display: inline-block;
            color: #7b1fa2;
            text-decoration: none;
            font-weight: bold;
            padding: 10px 20px;
            border: 2px solid #7b1fa2;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .back-to-cart:hover {
            background-color: #7b1fa2;
            color: white;
        }
        
        .loading-mp {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 1.1rem;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        .cart-summary {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .cart-total {
            font-size: 1.3rem;
            font-weight: bold;
            color: #7b1fa2;
            text-align: right;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #7b1fa2;
        }

        .checkout-buttons {
            text-align: center;
            margin: 30px 0;
        }

        .checkout-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: white;
        }

        .test-info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div id="header-container">
        <!-- Header será cargado por JavaScript -->
    </div>
    
    <main>
        <section class="checkout-container">
            <h1>Confirmación de Pedido</h1>
            <div id="payment-method-display">
                <div class="loading-mp">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Cargando información de pago...</p>
                </div>
            </div>
            
            <!-- Botón de Checkout Pro -->
            <div id="checkout-pro-container" class="checkout-buttons" style="display: none;">
                <div class="checkout-card">
                    <h3><i class="fas fa-credit-card"></i> Pago Seguro con Mercado Pago</h3>
                    <p>Serás redirigido a Mercado Pago para completar tu pago de forma segura</p>
                    <button id="checkout-pro-btn" class="btn-mp">
                        <i class="fas fa-lock"></i> Pagar Ahora con Mercado Pago
                    </button>
                </div>
            </div>
            
            <a href="cart.html" class="back-to-cart">← Cambiar método de pago</a>
        </section>
    </main>
    
    <footer class="site-footer">
        <p>© 2023 MAC Style Makeup Store. Proyecto estudiantil sin derechos de autor.</p>
    </footer>

    <script>
        // URL de tu backend - cambia el puerto si es necesario
        const BACKEND_URL = 'http://localhost:3001';

        document.addEventListener('DOMContentLoaded', function() {
            // Cargar header
            loadHeader();
            
            // Inicializar checkout
            initializeCheckout();
        });

        function loadHeader() {
            const headerHTML = `
                <header>
                    <div class="header-content">
                        <div class="logo">MAC Style</div>
                        <nav>
                            <ul>
                                <li><a href="index.html">Inicio</a></li>
                                <li><a href="cart.html">Carrito</a></li>
                            </ul>
                        </nav>
                    </div>
                </header>
            `;
            document.getElementById('header-container').innerHTML = headerHTML;
        }

        function initializeCheckout() {
            const paymentDisplay = document.getElementById('payment-method-display');
            
            // Obtener datos del localStorage
            const selectedMethod = localStorage.getItem('paymentMethod');
            const cartItems = JSON.parse(localStorage.getItem('carrito') || '[]');
            
            console.log('Método de pago:', selectedMethod);
            console.log('Items en carrito:', cartItems);

            // Validaciones
            if (!selectedMethod) {
                showError('No se seleccionó un método de pago. <a href="cart.html">Volver al carrito</a>');
                return;
            }

            if (cartItems.length === 0) {
                showError('El carrito está vacío. <a href="index.html">Agregar productos</a>');
                return;
            }

            // Calcular total
            const cartTotal = cartItems.reduce((sum, item) => sum + (parseFloat(item.precio) * parseInt(item.cantidad)), 0);
            const totalFixed = cartTotal.toFixed(2);
            
            // Mostrar resumen del carrito
            showCartSummary(cartItems, totalFixed);
            
            // Mostrar opción de pago según método seleccionado
            if (selectedMethod === 'mercado-pago') {
                showMercadoPagoOption(totalFixed, cartItems);
            } else {
                showError('Método de pago no disponible. <a href="cart.html">Elegir otro método</a>');
            }
        }

        function showError(message) {
            const paymentDisplay = document.getElementById('payment-method-display');
            paymentDisplay.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    ${message}
                </div>
            `;
        }

        function showCartSummary(items, total) {
            const summaryHTML = `
                <div class="cart-summary">
                    <h2>Resumen de tu Pedido</h2>
                    ${items.map(item => `
                        <div class="cart-item">
                            <span>${item.nombre} x ${item.cantidad}</span>
                            <span>$${(parseFloat(item.precio) * parseInt(item.cantidad)).toFixed(2)}</span>
                        </div>
                    `).join('')}
                    <div class="cart-total">Total: $${total}</div>
                </div>
            `;
            
            const paymentDisplay = document.getElementById('payment-method-display');
            paymentDisplay.innerHTML = summaryHTML;
        }

        function showMercadoPagoOption(total, items) {
            const paymentDisplay = document.getElementById('payment-method-display');
            const summary = paymentDisplay.innerHTML;
            
            paymentDisplay.innerHTML = summary + `
                <div class="payment-content">
                    <h2><i class="fas fa-money-check-alt"></i> Pagar con Mercado Pago</h2>
                    <p>Total a pagar: <strong>$${total} MXN</strong></p>
                    <p>Haz clic en el botón para ser redirigido a Mercado Pago:</p>
                </div>
                
               
            `;
            
            // Mostrar botón de Checkout Pro
            document.getElementById('checkout-pro-container').style.display = 'block';
            
            // Configurar el botón de Checkout Pro
            document.getElementById('checkout-pro-btn').onclick = function() {
                createCheckoutProPreference(total, items);
            };
        }

        async function createCheckoutProPreference(total, items) {
            try {
                const checkoutBtn = document.getElementById('checkout-pro-btn');
                checkoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando pago...';
                checkoutBtn.disabled = true;

                console.log('Enviando datos al backend:', { items, total });

                const response = await fetch(`${BACKEND_URL}/create-preference`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        items: items,
                        total: total
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error del servidor');
                }

                const data = await response.json();
                console.log('Preferencia creada:', data);

                // Redirigir a Mercado Pago
                if (data.init_point) {
                    window.location.href = data.init_point;
                } else {
                    throw new Error('No se recibió URL de pago');
                }
                
            } catch (error) {
                console.error('Error creando preferencia:', error);
                showError('Error al crear el pago: ' + error.message);
                
                // Mostrar opción de prueba como fallback
                showTestPaymentOptions(total, items);
                
                const checkoutBtn = document.getElementById('checkout-pro-btn');
                checkoutBtn.innerHTML = '<i class="fas fa-lock"></i> Pagar Ahora con Mercado Pago';
                checkoutBtn.disabled = false;
            }
        }

        function showTestPaymentOptions(total, items) {
            const paymentDisplay = document.getElementById('payment-method-display');
            
            paymentDisplay.innerHTML += `
                <div class="payment-content">
                    <h3><i class="fas fa-wrench"></i> Modo Prueba (Fallback)</h3>
                    <p>El servidor de pagos no está disponible. Usa el modo de prueba:</p>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        <button class="btn-mp" onclick="simulatePaymentSuccess('${total}')" 
                                style="background: #28a745; margin: 10px;">
                            <i class="fas fa-check-circle"></i> Simular Pago Exitoso
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('checkout-pro-container').style.display = 'none';
        }

        // Función para simular pago exitoso
        function simulatePaymentSuccess(total) {
            const paymentDisplay = document.getElementById('payment-method-display');
            
            paymentDisplay.innerHTML += `
                <div class="success-message">
                    <i class="fas fa-check-circle"></i>
                    ¡Pago exitoso! Procesando tu orden...
                </div>
            `;
            
            // Limpiar carrito y redirigir
            setTimeout(() => {
                localStorage.removeItem('carrito');
                localStorage.removeItem('paymentMethod');
                window.location.href = 'confirmation.html';
            }, 2000);
        }

        // Función para verificar el estado del backend
        async function checkBackendStatus() {
            try {
                const response = await fetch(`${BACKEND_URL}/health`);
                const data = await response.json();
                console.log('Backend status:', data);
                return true;
            } catch (error) {
                console.error('Backend no disponible:', error);
                return false;
            }
        }

        // Verificar backend al cargar la página
        window.addEventListener('load', async () => {
            const isBackendAlive = await checkBackendStatus();
            if (!isBackendAlive) {
                console.warn('Backend no disponible, usando modo prueba');
            }
        });
    </script>
</body>
</html>